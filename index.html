<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>

    <!-- [out:json];
rel[name="Київ"];
out geom; -->

    <style>
        #map {
            height: 800px;
            /* The height is 400 pixels */
            width: 100%;
            /* The width is the width of the web page */
        }
    </style>

    <div class="site-poligon">
        <select class="select-site-poligon">
            <option value="kyiv" selected>Киев</option>
            <option value="katiuzhanka">Катюжанка</option>
            <option value="bucha">Буча</option>
            <option value="brovary">Бровари</option>
        </select>
    </div>

    <div id="map"></div>

    <script>
        (g => {
            var h, a, k, p = "The Google Maps JavaScript API",
                c = "google",
                l = "importLibrary",
                q = "__ib__",
                m = document,
                b = window;
            b = b[c] || (b[c] = {});
            var d = b.maps || (b.maps = {}),
                r = new Set,
                e = new URLSearchParams,
                u = () => h || (h = new Promise(async (f, n) => {
                    await (a = m.createElement("script"));
                    e.set("libraries", [...r] + "");
                    for (k in g) e.set(k.replace(/[A-Z]/g, t => "_" + t[0].toLowerCase()), g[k]);
                    e.set("callback", c + ".maps." + q);
                    a.src = `https://maps.${c}apis.com/maps/api/js?` + e;
                    d[q] = f;
                    a.onerror = () => h = n(Error(p + " could not load."));
                    a.nonce = m.querySelector("script[nonce]") ?.nonce || "";
                    m.head.append(a)
                }));
            d[l] ? console.warn(p + " only loads once. Ignoring:", g) : d[l] = (f, ...n) => r.add(f) && u().then(
                () => d[l](f, ...n))
        })
        ({
            key: "AIzaSyB41DRUbKWJHPxaFjMAwdrzWzbVKartNGg",
            v: "weekly"
        });
        
        function createScriptData() {
            const selectSite = document.querySelector('.select-site-poligon');
            let script = null;

            // Функция для загрузки данных и вызова initMap с новыми данными
            function loadDataAndInitMap() {
                let selectedOption = selectSite.options[selectSite.selectedIndex];
                let jsonData = null;

                // Удаляем предыдущие скрипты, если они есть
                document.querySelectorAll('script[data-dynamic]').forEach(script => {
                    script.remove();
                });

                // Создаем элемент скрипта
                const script = document.createElement('script');
                script.src = `${selectedOption.value}.js`;
                script.setAttribute('data-dynamic', '');

                // Ожидаем загрузку скрипта
                script.onload = function() {
                    // После загрузки скрипта, предполагая что data() возвращает данные
                    jsonData = data(); // Переименовали переменную в jsonData и вызвали функцию data()
                    initMap(jsonData); // Вызываем функцию инициализации карты с полученными данными
                };

                // Добавляем скрипт на страницу
                document.body.append(script);
            }

            // Вызываем loadDataAndInitMap при первой загрузке страницы
            loadDataAndInitMap();

            // Обработчик события изменения выбора
            selectSite.addEventListener('change', function() {
                // При изменении выбора загружаем новые данные и вызываем initMap
                loadDataAndInitMap();
            });
        }

        createScriptData();

        async function initMap(data) {
            const choicedData = data;
            const { Map, Polygon  } = await google.maps.importLibrary("maps");
            const { AdvancedMarkerElement, PinElement } = await google.maps.importLibrary("marker");

            const polygonCoordinates = choicedData.features[0].geometry.coordinates[0];

            // Создаем массив для хранения координат полигона
            const paths = [];
            // Создаем переменные для хранения сумм координат
            let latSum = 0;
            let lngSum = 0;

            // Заполняем массив координатами полигона и вычисляем суммы координат
            polygonCoordinates.forEach(coord => {
                paths.push({ lat: coord[1], lng: coord[0] });
                latSum += coord[1];
                lngSum += coord[0];
            });

            // Вычисляем среднее значение широты и долготы
            const center = {
                lat: latSum / polygonCoordinates.length,
                lng: lngSum / polygonCoordinates.length
            };

            const map = new Map(document.getElementById("map"), {
                zoom: 10,
                center: center,
                mapId: "DEMO_MAP_ID",
                streetViewControl: false
            });

            // Создаем полигон
            const sitePolygon = new Polygon({
                paths: paths,
                strokeColor: "#FF0000",
                strokeOpacity: 0.7,
                strokeWeight: 1,
                fillColor: "#cd7a31",
                fillOpacity: 0.35,
            });

            // Отображаем полигон на карте
            sitePolygon.setMap(map);

            const pin = new PinElement({
                background: "#00a1de",
                glyph: 'text',
                borderColor: 'none',
            });

            const marker = new AdvancedMarkerElement({
                map,
                position: center,
                content: pin.element,
            });
        }

    </script>
    
</body>

</html>